# 网络成-基本原理

## 1 基本功能

网络层建立在链路层之上，它的最主要的功能是使得网络中的各个主机之间可以互相通信。在因特网中，IP层是TCP/IP协议族中最为核心的协议，也是最复杂的层次之一。网络层的功能是要将分组从一个主机移动到另一个主机从而使得主机之间可以互相通信。为此需要网络层提供两种功能：

### 存储转发

路由器（三层交换机）将进入其某个输入链路的分组转发到其某个输出链路。它是将分组从一个输入链路移动到一个输出链路，是一个路由器的本地动作。

### 路由选择

在分组从一个主机流向另一个主机的过程中，网络层必须决定分组所走过的路径。计算这个路径信息的算法就是路由算法。它是一个网络范围的动作，决定分组从其源到目的应该走的路径

### 连接建立

在有些计算机网络中，连接建立也是网络层的重要功能。比如ATM，它要求从源到目的地沿着所选择的路径彼此握手，以便在源和目的之间建立起状态。

## 2 服务特点
* 确保服务：确保能最终到达目的地
* 时延上界：不仅确保交付，而且确保在时上界内交付
* 有序分组交付：确保分组按照它们被发送的顺序到达目的地
* 确保最小带宽：只要发送主机以低于特定比特率的速录传输，分组就不会丢失
* 确保最大时延抖动：发送方发送两个连续分组的时间间隔和接收方接收它们的时间间隔之间的差值在一定范围内
* 安全性服务：使用仅仅发送方和接收方所知晓的密钥通信。但是因特网的网络层提供的是无连接的不可靠的服务，尽力而为的服务，其含义是：
* 不可靠：IP层不保证IP数据报能成功到达目的地。如果需要保证可靠传输，则需要使用其它协议，比如TCP。
* 无连接：IP不维护任何关于后续数据报状态的信息，每个数据报的处理是相互独立的。因此两个IP之间的多个报文可能乱序到达，可能走不同的路径。


## 3 网络类型

### 虚电路

### 数据报网络

在因特网中，每当一个主机要发送一个分组时， 它就为该分组加上目的主机的地址，然后将该分组发送出去。
当分组在网络中向目的地传输时，它会经过一系列路由器。每个路由器都使用该分组的目的地址来转发给分组。每台路由器都由一个将目的地址映射到链路接口的转发表，每当分组到达时，路由器就利用分组的目的地址在转发表中查找一个合适的输出链路接口，然后路由器将分组从该输出链路接口发送出去。
在因特网中，路由器的转发表可以由选路算法或者管理员更新。由于转发表的修改可能发生在任意时刻，因而两个主机之间的分组在不同的时刻走的可能是不同的网络路径，并可能无序到达。

最长前缀匹配规则

网络前缀：是网络地址的前边某些连续比特。比如对于地址 11101111 11011110 1000000 00000001，其对应的8比特前缀为11101111 ， 16比特前缀为11101111 11011110
在该规则下，路由器的转发表中记录的是网络前缀和输出链路接口之间的对应关系。当查转发表时，仍然利用目的地址来进行匹配，但是可能会有很多歌匹配，这个时候取匹配到的比特数目最多的表象作为命中表项，并根据它来转发分组。


## 4 路由器构成（硬件）


路由器在网络层是一个极其重要的设备，每台路由器都由一张转发表。路由器检查到达分组首部中的一个字段的值，然后利用该值在路由器的转发表中进行查询，以决定该如何转发该分组。查询的结果是分组将被转发的路由器的链路接口。

网络层的最主要的功能是将分组从一台主机移动到另一台主机。该功能主要是由路由器完成的。典型的路由器结构如下：

### 输入端口
它接入输入的物理链路，和链路远端的数据链路层交互，并完成查找和转发功能，以使得输入分组能够进入到合适输出链路接口。对于控制分组，它则会进入选路处理器。


输入端口的线路端接功能与数据链路处理实现了与通向路由器的各个输入链路相关的物理层和数据链路层。输入端口的查找/转发功能对路由器的转发功能是非常重要的。在很多路由器中，就是在这里来确定一个到达的分组经交换结构转发给哪个输出端口。输出端口的选择是取决于转发表中的信息，虽然转发表是由选路处理器计算的，但是通常每个输入端口都会有一份转发表的影子拷贝，并且会被及时更新。正因为输入端口拥有转发表的本地拷贝因而就可以在每个输入接口做出转发决策，而无需调用中央选路处理器，这种模式可以避免在路由器的某个节点产生转发处理瓶颈。
在输入端口处理能力受限的路由器中，输入端口会将分组转发给中央绚丽处理器，然后由它执行转发表查找并将分组转发到恰当的输出端口。
在有了转发表后，转发决策就很简单，就是查找转发表，但是由于主干路由器的转发表规模很大， 而且我们期望输入端口的处理速度能够达到线速或者说我们期望查表的速度越快越好，因而就需要对转发表的组织和查询进行优化，常见的方式有：
以树形结构存储转发表，树的每一级对应目的地址中的一个比特，如果地址比特位0则搜索其左子树，否则搜索右子树。采用这种结构，N比特的目的地址可以在N步之内找到相应的转发表项。
内容可寻址内存CAM，采用树形结构对于主干路由器来说还是太慢了，CAM允许将一个IP地址交给CAM，然后由CAM在常数时间内返回该地址对应的转发表项的内容。
将最近访问的转发表保存在高速缓存。
找到分组输出端口后，分组就可以进入交换结构。这个时候分组可能会被阻塞，因而来自其它输入端口的分组可能正在使用交换结构。被阻塞的分组需要在输入端口排队。

### 交换结构

它将路由器的输入接口连接到它的输出接口。



在这种由纵横式交换机构成的互联网络中任意两个端口之间都有自己的专用总线，因而可以克服单一、共享式总线的带宽限制。使用这种网络时，往往把长度变化的IP分组分片成固定尺寸的信元，加上标签通过互联网络进行交换，这些信元在输出接口再被装配成初始分组。这种方式能够极大的简化并加快通过互联网络的分组交换。

### 输出端口

存储经过交换结构发送给它的分组，并将分组发送出去。同时它执行和输入端口相反的链路层功能和物理层功能。
选路处理器：执行选路协议，维护选路信息和转发表。

输出端口取出存放在输出端口内存中的分组并将它传送到输出链路上。它在数据链路层和物理层上实现与输入接口相反的功能

### 排队
在输入端口和输出端口都可能出现排队。随着这些队列的增长，路由器的缓存空间可能会耗尽，进而导致出现丢包。
对于有N个输入接口和N个输出接口的路由器，定义交换结构速率为交换结构能够从输入端口移动分组到输出端口的速率。则如果交换结构的速率至少是输入线路速率的N倍，则在输入端口不会出现排队，这是因为即便所有的N个端口都在接收报文，交换结构也能够将其全部移动到输出接口。但是对于输出接口，假设交换结构速率为线路速率的N倍，则在最坏情况下，到达所有N个输入端口的分组都要被发送到同一个输出端口，在这个情况下，输出端口发送一个分组的同时它要接收N个分组，因而就会导致排队，这种情况持续下去就会导致输出端口的队列不断增长并耗尽内存出现丢包。
由于会出现排队，因而缓存大小的设置就非常关键，缓存大小设置的经验方法是：缓存量=平均往返时延*链路的容量。
1.分组调度
输出端口出现排队，一个重要的问题就是输出端口如何发送这些排队的分组，可能的方式有：
先来先服务FCFS
加权公平队列，它在具有排队等待传输的分组的不同的端到端连接之间公平的共享输出链路。
2.队列管理
另外的一个问题是如果没有足够的缓存来缓存一个分组，是丢弃该分组，还是丢弃一个已排队的分组来为新的分组腾出空间。相关的策略通常为主动队列管理算法AQM。随机早期检测算法RED是一种常见的算法，其思想是为输出队列长度维护一个加权平均值：
当队列长度小于低的门限值Tmin时，不丢弃新到达的分组；
当队列长度介于Tmin和Tmax之间时，以一定的概率丢弃分组，且分组概率随着队列长度的增长线性增加，
当队列长度达到Tmax时，到达的分组全部被丢弃。
这3个阶段分别被称作正常、拥塞避免和拥塞控制三个阶段。最坏情况的最大队列大小被限制为Tmax。


3.HOL
如果交换结构不能快得使所有分组都能无时延的通过它传送，则在输入端口也将出现分组排队。假设
所有链路速率都相同
一个分组能够以与一个输入链路接收一个分组相同的时间从任意一个输入端口移动分组到给定的输出端口
输入队列按照FCFS工作

假设输入端口中的每个数字都表示一个分组，数字值标识其想要转发到的输出端口，并且输入端口和输出端口都从下标1开始从上到下编号。在图中的场景下，假设交换结构决定先移动输入端口1中的分组到其输出端口，则输入端口3中的分组必须等待，进一步的，由于输入端口的队列采用FCFS的工作模式，因而输入端口3中的目的端口为2的分组也必须等待，尽管此时并没有其他输入端口和它竞争输出端口2，这种现象就叫Head-Of-the-Line阻塞，即HOL阻塞。
研究表明由于HOL阻塞，只要输入链路上的分组到达速率达到其容量的58%，在某些假设前提下，输入队列就将无限增大，从而导致丢包。
