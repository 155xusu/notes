# 网络层-基本原理

## 1 基本功能

网络层建立在链路层之上，它的最主要的功能是使得网络中的各个主机之间可以互相通信。在因特网中，IP层是TCP/IP协议族中最为核心的协议，也是最复杂的层次之一。网络层的功能是要将分组从一个主机移动到另一个主机从而使得主机之间可以互相通信。为此需要网络层提供两种功能：

### 存储转发

路由器（三层交换机）将进入其某个输入链路的分组转发到其某个输出链路。它是将分组从一个输入链路移动到一个输出链路，是一个路由器的本地动作。

### 路由选择

在分组从一个主机流向另一个主机的过程中，网络层必须决定分组所走过的路径。计算这个路径信息的算法就是路由算法。它是一个网络范围的动作，决定分组从其源到目的应该走的路径

### 连接建立

在有些计算机网络中，连接建立也是网络层的重要功能。比如ATM，它要求从源到目的地沿着所选择的路径彼此握手，以便在源和目的之间建立起状态。

## 2 服务特点
* 确保服务：确保能最终到达目的地
* 时延上界：不仅确保交付，而且确保在时上界内交付
* 有序分组交付：确保分组按照它们被发送的顺序到达目的地
* 确保最小带宽：只要发送主机以低于特定比特率的速录传输，分组就不会丢失
* 确保最大时延抖动：发送方发送两个连续分组的时间间隔和接收方接收它们的时间间隔之间的差值在一定范围内
* 安全性服务：使用仅仅发送方和接收方所知晓的密钥通信。但是因特网的网络层提供的是无连接的不可靠的服务，尽力而为的服务，其含义是：
* 不可靠：IP层不保证IP数据报能成功到达目的地。如果需要保证可靠传输，则需要使用其它协议，比如TCP。
* 无连接：IP不维护任何关于后续数据报状态的信息，每个数据报的处理是相互独立的。因此两个IP之间的多个报文可能乱序到达，可能走不同的路径。


## 3 网络类型

### 虚电路

### 数据报网络

在因特网中，每当一个主机要发送一个分组时， 它就为该分组加上目的主机的地址，然后将该分组发送出去。
当分组在网络中向目的地传输时，它会经过一系列路由器。每个路由器都使用该分组的目的地址来转发给分组。每台路由器都由一个将目的地址映射到链路接口的转发表，每当分组到达时，路由器就利用分组的目的地址在转发表中查找一个合适的输出链路接口，然后路由器将分组从该输出链路接口发送出去。
在因特网中，路由器的转发表可以由选路算法或者管理员更新。由于转发表的修改可能发生在任意时刻，因而两个主机之间的分组在不同的时刻走的可能是不同的网络路径，并可能无序到达。

### 最长前缀匹配规则

网络前缀：是网络地址的前边某些连续比特。比如对于地址 11101111 11011110 1000000 00000001，其对应的8比特前缀为11101111 ， 16比特前缀为11101111 11011110
在该规则下，路由器的转发表中记录的是网络前缀和输出链路接口之间的对应关系。当查转发表时，仍然利用目的地址来进行匹配，但是可能会有很多歌匹配，这个时候取匹配到的比特数目最多的表象作为命中表项，并根据它来转发分组。


## 4 路由器构成（硬件）

![asd](\image/路由器组成.png)

路由器在网络层是一个极其重要的设备，每台路由器都由一张**路由转发表**。

路由器检查到达分组首部中的一个字段的值，然后利用该值在路由器的转发表中进行查询，以决定该如何转发该分组。

查询的结果是分组将被转发的路由器的链路接口。

### 输入端口

它接入输入的物理链路，和链路远端的数据链路层交互，并完成查找和转发功能，以使得输入分组能够进入到合适输出链路接口。对于控制分组，它则会进入选路处理器。

确定一个到达的分组经交换结构转发给哪个输出端口。输出端口的选择是取决于转发表中的信息，转发表是由选路处理器计算的，每个输入端口都会有一份转发表的影子拷贝，并且会被及时更新。被阻塞的分组需要在输入端口排队。


需要对转发表的组织和查询进行优化，常见的方式有：
* 以树形结构存储转发表，树的每一级对应目的地址中的一个比特，如果地址比特位0则搜索其左子树，否则搜索右子树。采用这种结构，N比特的目的地址可以在N步之内找到相应的转发表项。

* 内容可寻址内存CAM，CAM允许将一个IP地址交给CAM，由CAM在常数时间内返回该地址对应的转发表项的内容。

* 将最近访问的转发表保存在高速缓存。


### 交换结构
![](\image/路由器交换结构.png)

它将路由器的输入接口连接到它的输出接口。


在这种由纵横式交换机构成的互联网络中任意两个端口之间都有自己的专用总线，因而可以克服单一、共享式总线的带宽限制。使用这种网络时，往往把长度变化的IP分组分片成固定尺寸的信元，加上标签通过互联网络进行交换，这些信元在输出接口再被装配成初始分组。这种方式能够极大的简化并加快通过互联网络的分组交换。

### 输出端口

存储经过交换结构发送给它的分组，并将分组发送出去。


### 选路处理器

执行选路协议，维护选路信息和转发表。


## 5 排队
在输入端口和输出端口都可能出现排队。缓存大小设置的经验方法是：缓存量=平均往返时延*链路的容量。

### 分组调度

输出端口出现排队，分组调度：
* 先来先服务FCFS
* 加权公平队列


### 队列管理

主动队列管理算法AQM。

### HOL
如果交换结构不能快得使所有分组都能无时延的通过它传送，则在输入端口也将出现分组排队。输入队列按照FCFS工作
